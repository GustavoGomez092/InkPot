# Implementation Plan: Mermaid.js Diagram Support

**Branch**: `002-mermaid-diagrams` | **Date**: 2025-12-01 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/002-mermaid-diagrams/spec.md`

**Note**: This plan was generated by the `/speckit.plan` command following the SpecKit workflow.

## Summary

Add Mermaid.js diagram support to the InkPot rich text editor, enabling users to insert and edit diagrams via a modal editor with toolbar button access. Diagrams render as visual placeholders in the editor and as images in PDF exports. Implementation leverages Tiptap's custom node system for diagram storage, React Dialog components for the modal UI, and Mermaid.js library for rendering.

## Technical Context

**Language/Version**: TypeScript 5.x with strict mode, React 19
**Primary Dependencies**: 
- Core: Electron (latest stable), Tiptap 2.x, Tailwind CSS 4.x, @react-pdf/renderer
- New: mermaid (latest stable), @tiptap/core, @tiptap/react
- UI: Radix UI Dialog components (existing), shadcn/ui components (existing)

**Storage**: Local file system (existing document persistence layer via Electron main process)
**Testing**: Vitest with React Testing Library, Electron testing utilities
**Target Platform**: Desktop (macOS, Windows, Linux) via Electron
**Project Type**: Electron desktop application with rich text editing
**Performance Goals**: 
- Modal open/close: <200ms
- Diagram insertion: <5s (per spec SC-001)
- Diagram edit reopen: <2s (per spec SC-002)
- Support up to 20 diagrams per document without degradation (per spec SC-008)

**Constraints**: 
- Must maintain existing document structure and serialization format
- Mermaid.js rendering performance limits complex diagrams
- Main process must remain responsive during PDF generation
- Bundle size impact from Mermaid.js library (~800KB)

**Scale/Scope**: Single-user document editing with embedded diagrams, no collaborative features

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Initial Check (Pre-Research)

- [x] **Component Isolation**: 
  - Diagram modal will be isolated React component accepting props (diagramCode, onSave, onCancel)
  - Editor integration via Tiptap extension (standard pattern)
  - No direct Electron API access from renderer components
  
- [x] **Type Safety**: 
  - All diagram node attributes will have TypeScript interfaces
  - Mermaid validation return types will be typed
  - IPC contracts for PDF rendering will use existing typed channels (no new IPC needed for core feature)
  
- [x] **Performance First**: 
  - React 19 compiler will handle diagram modal rendering
  - Mermaid.js library will be code-split and lazy-loaded
  - Initial render unaffected (diagrams load post-render)
  - 20-diagram limit ensures performance target met
  
- [x] **Content Model Integrity**: 
  - Custom Tiptap node will follow ProseMirror schema contracts
  - Diagram code stored as node attribute (string)
  - Undo/redo handled automatically by Tiptap/ProseMirror
  - Serialization preserves diagram code in document JSON
  
- [x] **Cross-Process Communication**: 
  - Diagram feature operates entirely in renderer process
  - PDF rendering uses existing IPC channel (no new main process code needed initially)
  - Future: PDF rendering may need IPC for server-side Mermaid rendering (Phase 2 consideration)

**Status**: ✅ PASSED - Feature aligns with all constitutional principles

## Project Structure

### Documentation (this feature)

```text
specs/[###-feature]/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```text
src/
├── main/                          # Main process (existing)
│   └── pdf/                      # PDF generation (existing)
│       ├── components/           
│       │   └── MermaidDiagram.tsx  # NEW: Mermaid rendering for PDF
│       └── markdown-parser.ts    # MODIFIED: Parse mermaid blocks
│
├── renderer/                      # Renderer process
│   ├── components/               # React components (existing)
│   │   └── editor/
│   │       └── MermaidModal.tsx  # NEW: Diagram editor modal
│   │
│   ├── editor/                   # Tiptap extensions (existing)
│   │   ├── mermaid-extension.ts  # NEW: Custom Tiptap node
│   │   ├── MermaidNodeView.tsx   # NEW: React NodeView component
│   │   └── markdown-serializer.ts # MODIFIED: Serialize mermaid nodes
│   │
│   ├── hooks/                    # Custom hooks (existing)
│   │   └── useMermaid.ts         # NEW: Mermaid validation/rendering hook
│   │
│   └── lib/                      # Utilities (existing)
│       └── mermaid-utils.ts      # NEW: Mermaid validation helpers
│
└── shared/                        # Shared code (existing)
    └── types/
        └── mermaid.ts             # NEW: Diagram node types

tests/
├── unit/
│   ├── mermaid-extension.test.ts      # NEW: Extension tests
│   ├── MermaidNodeView.test.tsx       # NEW: NodeView tests
│   └── mermaid-utils.test.ts          # NEW: Validation tests
└── integration/
    └── mermaid-pdf-export.test.ts     # NEW: PDF rendering tests
```

**Structure Decision**: 
- **Renderer-focused implementation**: Core feature lives entirely in renderer process (modal UI, editor extension, diagram storage)
- **Minimal main process changes**: Only PDF rendering component added to existing PDF generation infrastructure
- **Leverages existing patterns**: Uses established Tiptap extension pattern (similar to image-extension.ts), existing modal component architecture, and current markdown serialization system
- **Type safety**: New shared types in `/shared/types/` ensure type consistency across processes

## Complexity Tracking

**Status**: ✅ No constitutional violations

This feature introduces no additional complexity beyond standard Tiptap extension patterns already established in the codebase. All new code follows existing architectural patterns:
- Custom Tiptap node (similar to existing image-extension.ts)
- React NodeView component (standard pattern)
- Modal dialog component (using existing Radix UI infrastructure)
- PDF rendering component (extends existing @react-pdf/renderer setup)
